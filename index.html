<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 16px; }
    .wrap { max-width: 720px; margin: 0 auto; }
    img { width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px; }
    input, button { font-size: 16px; padding: 10px; }
    input { width: 100%; box-sizing: border-box; margin-top: 10px; }
    .row { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    button { flex: 1; min-width: 140px; }
    .meta { margin: 10px 0; color: #555; }
    .result { margin-top: 12px; font-weight: 700; }
    .small { color: #666; font-size: 14px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>クイズ</h2>
    <div class="meta" id="meta"></div>
    <img id="qimg" alt="question image" />
    <input id="answer" type="text" placeholder="答えを入力" autocomplete="off" />
    <div class="row">
      <button id="btnCheck">判定</button>
      <button id="btnShow">答えを見る</button>
      <button id="btnNext">次へ</button>

    </div>
    <div class="result" id="result"></div>
    <div class="small" id="score"></div>
    <!-- 達成率バー（3連続達成） -->
    <div class="small" style="margin:10px 0;">
      <div>達成率（3連続達成）: <span id="masterPct">0% (0/0)</span></div>
      <div style="border:1px solid #ddd; border-radius:8px; overflow:hidden; height:14px;">
        <div id="masterBar" style="height:14px; width:0%; background:#4caf50;"></div>
      </div>
    </div>

    <!-- 実績同期（コピペ） -->
    <div class="row">
      <button id="btnExport">実績エクスポート</button>
      <button id="btnImport">実績インポート</button>
      <button id="btnResetStats">実績リセット</button>
    </div>

    <textarea id="syncBox" rows="6" style="width:100%; margin-top:10px; display:none;"
      placeholder="ここに実績JSONが表示されます（コピー用）／または貼り付けてインポートします"></textarea>

    <div class="row" id="syncRow" style="display:none;">
      <button id="btnCopy">コピー</button>
      <button id="btnApply">この内容で取り込み</button>
      <button id="btnCloseSync">閉じる</button>
    </div>

    <div class="small" id="syncMsg"></div>

  </div>

<script>
  // ====== 設定 ======
  const JSON_FILE = "uzaku_green.json";
  const SKIP_STREAK = 3;                 // 3回連続正解でクリア（以後スキップ）
  const LS_KEY = "uzaku_green_stats_v1"; // 実績保存＆同期用
  // ==================

  let allQs = []; // 全問題（JSONそのまま）
  let qs = [];    // 出題プール（未クリアのみ）
  let idx = 0;

  // stats: { [no]: {streak, correct, wrong} }
  let stats = loadStats();

  function loadStats() {
    try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveStats() {
    localStorage.setItem(LS_KEY, JSON.stringify(stats));
  }
  function getStat(no) {
    const key = String(no);
    if (!stats[key]) stats[key] = { streak: 0, correct: 0, wrong: 0 };
    return stats[key];
  }

  function normalize(s) {
    return (s ?? "")
      .toString()
      .trim()
      .toLowerCase()
      .replace(/\s+/g, " ")
      .normalize("NFKC");
  }

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  // ====== 累計集計 ======
  function countMastered() {
    let mastered = 0;
    for (const q of allQs) {
      if (getStat(q.no).streak >= SKIP_STREAK) mastered += 1;
    }
    return mastered;
  }

  function getTotalsFromStats() {
    let totalCorrect = 0;
    let totalWrong = 0;

    for (const k of Object.keys(stats)) {
      const s = stats[k] || {};
      totalCorrect += (s.correct || 0);
      totalWrong += (s.wrong || 0);
    }
    return { totalCorrect, totalWrong, totalAnswered: totalCorrect + totalWrong };
  }

  function updateMasterUI() {
    const total = allQs.length || 0;
    const mastered = countMastered();
    const pct = total ? Math.round((mastered / total) * 100) : 0;

    const pctEl = document.getElementById("masterPct");
    const barEl = document.getElementById("masterBar");
    if (pctEl) pctEl.textContent = `${pct}% (${mastered}/${total})`;
    if (barEl) barEl.style.width = `${pct}%`;
  }

  function updateScore() {
    const { totalCorrect, totalWrong, totalAnswered } = getTotalsFromStats();
    const mastered = countMastered();
    const scoreEl = document.getElementById("score");
    if (!scoreEl) return;

    scoreEl.textContent =
      `回答数: ${totalAnswered} / 正解数: ${totalCorrect} / 不正解数: ${totalWrong} ｜ クリア(3連続): ${mastered}/${allQs.length}`;
  }

  // ====== 出題プール（未クリアのみ） ======
  function rebuildPool() {
    qs = allQs.filter(q => getStat(q.no).streak < SKIP_STREAK);
    shuffle(qs);
    idx = 0;
    updateMasterUI();
    updateScore();
  }

  function setQuestion() {
    if (qs.length === 0) {
      document.getElementById("meta").textContent = "全問クリア！（3連続正解でクリア済み）";
      document.getElementById("qimg").removeAttribute("src");
      document.getElementById("result").textContent = "実績リセットで最初からできます。";
      updateMasterUI();
      updateScore();
      return;
    }

    const q = qs[idx];

    // 表示はシンプルに（Noや連続表示は無し）
    document.getElementById("meta").textContent =
      `問題 ${idx + 1} / ${qs.length}`;

    const img = document.getElementById("qimg");
    img.onerror = null; // 前のエラー設定をクリア
    img.src = encodeURI((q.image || "").trim());

    document.getElementById("answer").value = "";
    document.getElementById("result").textContent = "";

    updateMasterUI();
    updateScore();
  }

  // ====== ボタン動作 ======
  function showAnswer() {
    if (qs.length === 0) return;
    const q = qs[idx];

    const fileWithExt = (q.image || "").split("/").pop();         // xxx.png
    const fileNoExt = (fileWithExt || "").replace(/\.png$/i, ""); // xxx

    document.getElementById("result").textContent =
      `答え: ${q.answer} / filename: ${fileNoExt}`;
  }

  function checkAnswer() {
    if (qs.length === 0) return;

    const q = qs[idx];
    const user = normalize(document.getElementById("answer").value);
    const ans = normalize(q.answer);

    if (!user) {
      document.getElementById("result").textContent = "答えを入力してください。";
      return;
    }

    const st = getStat(q.no);

    if (user === ans) {
      st.correct += 1;
      st.streak += 1;

      if (st.streak >= SKIP_STREAK) {
        document.getElementById("result").textContent = `✅ 正解！ 3連続達成 → クリア（以後スキップ）`;
        // クリアした問題はプールから除外
        qs.splice(idx, 1);
        if (idx >= qs.length) idx = 0;
      } else {
        document.getElementById("result").textContent = `✅ 正解！`;
      }
    } else {
      st.wrong += 1;
      st.streak = 0;
      document.getElementById("result").textContent = `❌ 不正解。正解: ${q.answer}`;
    }

    saveStats();
    updateMasterUI();
    updateScore();
  }

  function nextQuestion() {
    if (qs.length === 0) return;
    idx = (idx + 1) % qs.length;
    setQuestion();
  }

  // ====== 同期UI（プランB：コピペ） ======
  function openSyncUI(text = "") {
    const box = document.getElementById("syncBox");
    const row = document.getElementById("syncRow");
    if (!box || !row) return;

    box.style.display = "block";
    row.style.display = "flex";
    box.value = text;
    const msg = document.getElementById("syncMsg");
    if (msg) msg.textContent = "";
    box.focus();
  }

  function closeSyncUI() {
    const box = document.getElementById("syncBox");
    const row = document.getElementById("syncRow");
    if (box) box.style.display = "none";
    if (row) row.style.display = "none";
    const msg = document.getElementById("syncMsg");
    if (msg) msg.textContent = "";
  }

  function exportStatsText() {
    const text = localStorage.getItem(LS_KEY) || "{}";
    openSyncUI(text);
    const msg = document.getElementById("syncMsg");
    if (msg) msg.textContent = "このJSONをコピー → 別端末で貼り付け → 取り込みしてください。";
  }

  function importStatsText(text) {
    let obj;
    try {
      obj = JSON.parse(text);
      if (typeof obj !== "object" || obj === null) throw new Error("not object");
    } catch {
      const msg = document.getElementById("syncMsg");
      if (msg) msg.textContent = "JSONの形式が正しくありません。";
      return;
    }

    stats = obj;
    saveStats();
    rebuildPool();
    setQuestion();

    const msg = document.getElementById("syncMsg");
    if (msg) msg.textContent = "取り込み完了。";
  }

  function resetStats() {
    if (!confirm("実績をリセットしますか？")) return;
    stats = {};
    saveStats();
    rebuildPool();
    setQuestion();
  }

  // ====== 初期化 ======
  async function init() {
    const res = await fetch(JSON_FILE);
    allQs = await res.json();
    rebuildPool();
    setQuestion();
  }

  // ====== イベント登録 ======
  document.getElementById("btnCheck")?.addEventListener("click", checkAnswer);
  document.getElementById("btnShow")?.addEventListener("click", showAnswer);
  document.getElementById("btnNext")?.addEventListener("click", nextQuestion);

  document.getElementById("answer")?.addEventListener("keydown", (e) => {
    if (e.key === "Enter") checkAnswer();
  });

  document.getElementById("btnExport")?.addEventListener("click", exportStatsText);
  document.getElementById("btnImport")?.addEventListener("click", () => openSyncUI(""));
  document.getElementById("btnResetStats")?.addEventListener("click", resetStats);

  document.getElementById("btnCopy")?.addEventListener("click", async () => {
    const box = document.getElementById("syncBox");
    const msg = document.getElementById("syncMsg");
    if (!box) return;

    try {
      await navigator.clipboard.writeText(box.value);
      if (msg) msg.textContent = "コピーしました。";
    } catch {
      box.select();
      if (msg) msg.textContent = "長押し→コピーで手動コピーしてください。";
    }
  });

  document.getElementById("btnApply")?.addEventListener("click", () => {
    const box = document.getElementById("syncBox");
    if (!box) return;
    importStatsText(box.value);
  });

  document.getElementById("btnCloseSync")?.addEventListener("click", closeSyncUI);

  init().catch(err => {
    const result = document.getElementById("result");
    if (result) result.textContent = "読み込みに失敗しました。";
    console.error(err);
  });
</script>

</body>
</html>
